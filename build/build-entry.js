const Components = require('../components.json');
const fs = require('fs');
const path = require('path');
const render = require('json-templater/string');
const uppercamelcase = require('uppercamelcase');
const endOfLine = require('os').EOL;

let OUTPUT_PATH = path.join(__dirname, '../packages/index.js');
let IMPORT_TEMPLATE = 'import {{name}} from \'../packages/{{package}}/index.js\';';
let INSTALL_COMPONENT_TEMPLATE = '{{name}}'
let MAIN_TEMPLATE = `/* Automaticaly generated by './build/build-entry.js'*/
{{include}}

const components = [
{{install}}
];

const install = function (Vue, opts={}) {
	if (install.installed) return;
	components.map(component => {
		Vue.component(component.name, component);
	});
}

if (typeof window !== 'undefined' && window.Vue) {
	install(window.Vue);
}

export default{
	version: '{{version}}',
	install
};
`;

let ComponentNames = Object.keys(Components);
let includeComponentTemplate = [];
let installTemplate = [];

ComponentNames.forEach(name => {
	var componentName = uppercamelcase(name);
	includeComponentTemplate.push(render(IMPORT_TEMPLATE,{
		name: componentName,
		package: name
	}));
	installTemplate.push(render(INSTALL_COMPONENT_TEMPLATE,{
		name: '	'+componentName
	}));
});

var template = render(MAIN_TEMPLATE,{
	include: includeComponentTemplate.join(endOfLine),
	install: installTemplate.join(','+endOfLine),
	version: require('../package.json').version
});

fs.writeFileSync(OUTPUT_PATH, template);
console.log('[build entry] DONE:', OUTPUT_PATH);